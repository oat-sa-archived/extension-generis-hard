function TaoGridClass(selector,model,dataUrl,options){this.selector=selector,this.jqGrid=null,this.model=model,this.data=[],this.dataUrl=dataUrl,this.jqGridModel=[],this.jqGridColumns=[],this.adapters=[],this.options=$.extend([],TaoGridClass.defaultOptions,options),null==this.options.height&&(this.options.height=$(this.selector).parent().height()),null==this.options.width&&(this.options.width=$(this.selector).parent().width()),this.initModel(),this.initGrid()}define("generisHard/controller/routes",[],function(){return{Optimize:{actions:{index:"controller/settings/optimizer"}}}}),TaoGridClass.__NEW_ROW__="__NEW_ROW__",TaoGridClass.prototype.initModel=function(){var columnsWeight=0,gridWidth=this.options.width;
for(var id in this.model){var weight="undefined"!=typeof this.model[id].weight?this.model[id].weight:1;columnsWeight+=weight}var i=0;for(var id in this.model){var position="undefined"!=typeof this.model[id].position?this.model[id].position:i;if(position!=i&&(this.jqGridColumns.splice(position,0,null),this.jqGridModel.splice(position,0,null)),this.jqGridColumns[position]=this.model[id].title,this.jqGridModel[position]={name:this.model[id].id,index:this.model[id].id,align:"undefined"!=typeof this.model[id].align?this.model[id].align:"left"},"undefined"!=typeof this.model[id].widget&&"Label"!=this.model[id].widget){var adapter=this.getAdapter(this.model[id].widget);
this.adapters[this.model[id].id]=adapter,this.jqGridModel[position].formatter=adapter.formatter}if("variables"==this.model[id].title){var adapterClass=window.TaoGridActivityVariablesAdapter;this.jqGridModel[position].formatter=adapterClass.formatter}var weight="undefined"!=typeof this.model[id].weight?this.model[id].weight:1,width=gridWidth*weight/columnsWeight-4;this.jqGridModel[position].width=width,i++}},TaoGridClass.prototype.initGrid=function(){var self=this;this.jqGrid=$(this.selector).jqGrid({datatype:"local",mtype:"GET",colNames:this.jqGridColumns,colModel:this.jqGridModel,shrinkToFit:!0,caption:this.options.title,jsonReader:{repeatitems:!1,id:"0"},height:this.options.height-54,autowidth:!0,onSelectRow:function(id){null!==self.options.callback.onSelectRow&&self.options.callback.onSelectRow(id)
}})},TaoGridClass.prototype.getAdapter=function(widget){var returnValue=null,adapterClassName="TaoGrid"+widget+"Adapter",adapterClass=window[adapterClassName];if(!adapterClass)throw new Error("Tao grid adapter (TaoGrid"+widget+"Adapter) does not exist");return returnValue=adapterClass},TaoGridClass.prototype.empty=function(){var gridBody=$(this.selector).children("tbody"),firstRow=gridBody.children("tr.jqgfirstrow");gridBody.empty().append(firstRow),this.data=[],this.jqGrid.clearGridData()},TaoGridClass.prototype.deleteRow=function(rowId){jQuery(this.selector).jqGrid("delRowData",rowId)},TaoGridClass.prototype.refresh=function(data){for(var rowId in data){this.data[rowId]=null,this.data[rowId]=data[rowId];
for(var columnId in this.adapters)"undefined"!=typeof this.adapters[columnId].preFormatter&&(this.data[rowId][columnId]=this.adapters[columnId].preFormatter(this,this.data[rowId],rowId,columnId));jQuery(this.selector).jqGrid("setRowData",rowId,this.data[rowId]);for(var columnId in this.adapters)if("undefined"!=typeof this.adapters[columnId].postCellFormat){var cell=this.getCell(rowId,columnId);this.adapters[columnId].postCellFormat(this,cell,rowId,columnId)}}},TaoGridClass.prototype.getPosition=function(rowId){var returnValue=-1,i=-1;return $(this.selector).find("tbody:first").children().each(function(){return $(this).attr("id")==rowId?void(returnValue=i):void i++
}),returnValue},TaoGridClass.prototype.editRow=function(rowId){var self=this,actionsHtml='<div class="grid-row-actions"> 		<a href="#" class="grid-row-action grid-row-save"><img src="'+root_url+'tao/views/img/save.png"/> Save</a> 		<a href="#" class="grid-row-action grid-row-cancel"><img src="'+root_url+'tao/views/img/revert.png"/> Cancel</a> 	</div>',row=this.getRow(rowId),$actionContainer=$(actionsHtml).insertAfter($(row));for(var columnId in this.adapters)if("undefined"!=typeof this.adapters[columnId].editFormatter){var cell=this.getCell(rowId,columnId);this.adapters[columnId].editFormatter(this,cell,rowId,columnId)}$actionContainer.find(".grid-row-save").one("click",function(){var rowData=[];
for(var columnId in self.adapters)if("undefined"!=typeof self.adapters[columnId].getEditedValue){var cell=self.getCell(rowId,columnId);rowData[columnId]=self.adapters[columnId].getEditedValue(self,cell,rowId,columnId)}else rowData[columnId]=self.data[rowId];$actionContainer.remove(),null!=self.options.callback.saveEditedRow&&self.options.callback.saveEditedRow(rowId,rowData)}),$actionContainer.find(".grid-row-cancel").one("click",function(){var dataToRefresh=[];dataToRefresh[rowId]=self.getRowData(rowId),self.refresh(dataToRefresh),$actionContainer.remove()})},TaoGridClass.prototype.newRow=function(){var self=this,defaultRowData={code:"",value:[]},rowId=TaoGridClass.__NEW_ROW__,actionsHtml='<div class="grid-row-actions"> 		<a href="#" class="grid-row-action grid-row-save"><img src="'+root_url+'tao/views/img/save.png"/> Save</a> 		<a href="#" class="grid-row-action grid-row-cancel"><img src="'+root_url+'tao/views/img/revert.png"/> Cancel</a> 	</div>',row=null;
jQuery(this.selector).jqGrid("addRowData",rowId,defaultRowData),row=this.getRow(rowId);var $actionContainer=$(actionsHtml).insertAfter($(row));for(var columnId in this.adapters)if("undefined"!=typeof this.adapters[columnId].editFormatter){var cell=this.getCell(rowId,columnId);this.adapters[columnId].editFormatter(this,cell,rowId,columnId)}$actionContainer.find(".grid-row-save").click(function(){var rowData=[];for(var columnId in self.adapters)if("undefined"!=typeof self.adapters[columnId].getEditedValue){var cell=self.getCell(rowId,columnId);rowData[columnId]=self.adapters[columnId].getEditedValue(self,cell,rowId,columnId)}else rowData[columnId]=self.data[rowId];
$actionContainer.remove(),null!=self.options.callback.saveNewRow&&self.options.callback.saveNewRow(rowId,rowData)}),$actionContainer.find(".grid-row-cancel").click(function(){jQuery(self.selector).jqGrid("delRowData",rowId),$actionContainer.remove()})},TaoGridClass.prototype.add=function(data){var self=this,crtLine=0;for(var i in data)this.data[i]=data[i];for(var rowId in data){for(var columnId in this.adapters)"undefined"!=typeof this.adapters[columnId].preFormatter&&(this.data[rowId][columnId]=this.adapters[columnId].preFormatter(this,this.data[rowId],rowId,columnId));jQuery(this.selector).jqGrid("addRowData",rowId,this.data[rowId]);for(var columnId in this.adapters)if("undefined"!=typeof this.adapters[columnId].postCellFormat){var cell=this.getCell(rowId,columnId);
this.adapters[columnId].postCellFormat(this,cell,rowId,columnId)}crtLine++;var row=this.getRow(rowId);$(row).find("> td").dblclick(function(){var cellIdentifier=self.getCellIdentifier(this);self.editRow(cellIdentifier.rowId)})}return crtLine},TaoGridClass.prototype.getRow=function(rowId){var returnValue=null,$row=$(this.selector).find('tr[id="'+rowId+'"]');return $row.length>0&&(returnValue=$row.get(0)),returnValue},TaoGridClass.prototype.getCell=function(rowId,columnId){var returnValue=null;return $cell=$(this.selector).find('tr[id="'+rowId+'"]').find('td[aria-describedby="'+this.selector.slice(1)+"_"+columnId+'"]'),$cell.length>0&&(returnValue=$cell.get(0)),returnValue
},TaoGridClass.prototype.getRowData=function(rowId){return"undefined"!=typeof this.data[rowId]?this.data[rowId]:void 0},TaoGridClass.prototype.getCellData=function(rowId,columnId){var returnValue=null,rowData=this.getRowData(rowId);return rowData&&"undefined"!=typeof rowData[columnId]&&(returnValue=rowData[columnId]),returnValue},TaoGridClass.prototype.getCellIdentifier=function(cell){var returnValue={rowId:null,columnId:null},columnTmp=$(cell).attr("aria-describedby");columnTmp&&(columnTmp=columnTmp.substr(this.selector.length),returnValue.columnId=columnTmp);var $row=$(cell).parent("tr"),rowTmp=$row.attr("id");return rowTmp&&(returnValue.rowId=rowTmp),returnValue
},TaoGridClass.defaultOptions={height:null,width:null,title:"GRID",callback:{onSelectRow:null}},define("grid/tao.grid",function(){}),define("generisHard/Switcher",["jquery","context","i18n"],function($,context,__){function Switcher(tableElementId,userOptions){this.options={onStart:function(){},onStartDecompile:function(){},onStartEmpty:function(){},beforeComplete:function(){},onComplete:function(){},onCompleteDecompile:function(){}},userOptions&&(this.options=$.extend(this.options,userOptions)),this.$grid=$("#"+tableElementId),this.theData=[],this.currentIndex=-1,this.forcedStart=!1,this.decompile=!1,Switcher.instances[tableElementId]=this}return Switcher.instances=[],Switcher.prototype.getActionUrl=function(action){var url=context.root_url;
return url+="generisHard/Optimize/"+action},Switcher.prototype.init=function(){var __this=this,actionUrl=__this.getActionUrl("optimizeClasses");return $.ajax({type:"POST",url:actionUrl,data:{},dataType:"json",success:function(r){if(0==r.length)return __this.options.onStartEmpty&&__this.options.onStartEmpty(__this),!1;var gridOptions={datatype:"local",hidegrid:!1,colNames:[__("Classes"),__("Status"),__("Instances")],colModel:[{name:"class",index:"class",sortable:!1},{name:"status",index:"status",align:"center",sortable:!1},{name:"count",index:"count",align:"center",sortable:!1}],height:"auto",autowidth:!0,width:parseInt(__this.$grid.width())-2,sortname:"status",sortorder:"asc",caption:__("Available Classes")};
require(["require","jquery","grid/tao.grid"],function(){__this.$grid.jqGrid(gridOptions);var i=0;for(var uri in r){var row=r[uri],rClass=row["class"],rClassUri=row.classUri,rStatus=__("compiled"===row.status?"Production":"Design"),rCount=row.count,rStatusTag=row.status;__this.setRowData(i,{"class":rClass,status:rStatus,count:rCount,classUri:rClassUri,statusTag:rStatusTag}),i++}})}}),!0},Switcher.prototype.startCompilation=function(){this.decompile=!1,this.currentIndex=0;for(var j=0;j<this.theData.length;j++)this.currentIndex<0&&"compiled"!==this.theData[j].statusTag&&(this.currentIndex=j);this.options.onStart&&this.options.onStart(this),this.nextStep()},Switcher.prototype.startDecompilation=function(){this.currentIndex=0,this.decompile=!0,this.options.onStartDecompile&&this.options.onStartDecompile(this);
for(var j=0;j<this.theData.length;j++)this.currentIndex<0&&"decompiled"!==this.theData[j].statusTag&&(this.currentIndex=j);this.nextStep()},Switcher.prototype.setRowData=function(rowId,data){"undefined"!=typeof this.theData[rowId]?this.$grid.jqGrid("setRowData",rowId,data):this.$grid.jqGrid("addRowData",rowId,data),this.theData[rowId]=data},Switcher.prototype.setCellData=function(rowId,colName,data){this.$grid.jqGrid("setCell",rowId,colName,data),this.theData[rowId][colName]=data},Switcher.prototype.addResultData=function(rowId,data){this.theData[rowId].compilationResults=null,this.theData[rowId].compilationResults=data},Switcher.prototype.getRowIdByUri=function(classUri){var returnValue=-1;
for(var rowId in this.theData)if(this.theData[rowId].classUri===classUri){returnValue=rowId;break}return returnValue},Switcher.prototype.nextStep=function(){this.currentIndex<this.theData.length?this.decompile===!0&&"decompiled"!==this.theData[this.currentIndex].statusTag?this.decompileClass(this.theData[this.currentIndex].classUri):this.decompile===!1&&"compiled"!==this.theData[this.currentIndex].statusTag&&this.compileClass(this.theData[this.currentIndex].classUri):this.end()},Switcher.prototype.compileClass=function(classUri){var __this=this,rowId=this.getRowIdByUri(classUri);this.setCellData(rowId,"status",__("Switching to Production...")),$.ajax({type:"POST",url:__this.getActionUrl("compileClass"),data:{classUri:classUri,options:""},dataType:"json",success:function(r){if(__this.addResultData(rowId,r),r.success){var selfCount=r.count,relatedCount=0;
for(var relatedClassName in r.relatedClasses)relatedCount+=parseInt(r.relatedClasses[relatedClassName]);var count=" ("+(selfCount+relatedCount)+" "+__("instances")+")";__this.setCellData(rowId,"status",__("Production")+count),__this.setCellData(rowId,"statusTag","compiled")}else __this.setCellData(rowId,"status",__("Failed"));__this.currentIndex++,__this.nextStep()}})},Switcher.prototype.decompileClass=function(classUri){var __this=this,rowId=this.getRowIdByUri(classUri);this.setCellData(rowId,"status",__("Switching to Design...")),$.ajax({type:"POST",url:__this.getActionUrl("decompileClass"),data:{classUri:classUri,options:""},dataType:"json",success:function(r){if(__this.addResultData(rowId,r),r.success){var selfCount=r.count,relatedCount=0;
for(var relatedClassName in r.relatedClasses)relatedCount+=parseInt(r.relatedClasses[relatedClassName]);var count=" ("+(selfCount+relatedCount)+" "+__("instances")+")";__this.setCellData(rowId,"status",__("Design")+count),__this.setCellData(rowId,"statusTag","decompiled")}else __this.setCellData(rowId,"status",__("Failed"));__this.currentIndex++,__this.nextStep()}})},Switcher.prototype.end=function(){var __this=this;this.options.beforeComplete&&this.options.beforeComplete(this),__this.decompile?__this.options.onCompleteDecompile&&__this.options.onCompleteDecompile(this):$.ajax({type:"POST",url:__this.getActionUrl("createPropertyIndex"),data:{},dataType:"json",success:function(r){__this.options.onComplete&&__this.options.onComplete(this,r.success)
}})},Switcher}),define("generisHard/controller/settings/optimizer",["jquery","i18n","generisHard/Switcher"],function($,__,Switcher){return{start:function(){var $compilationGrid=$("#compilation-grid-container"),$compilationResutlts=$("#compilation-grid-results"),$compileButton=$("#compileButton"),$decompileButton=$("#decompileButton"),options={onStart:function(){$compilationGrid.show()},onStartEmpty:function(){$compilationResutlts.html(__("There are no classes available for optimization.")).show()},onStartDecompile:function(){$compilationGrid.show()},beforeComplete:function(){$compilationResutlts.html(__("Rebuilding indexes, it may take a while.")).show()},onComplete:function(aSwitcher,success){success?$compilationResutlts.html(__("Switch to Production Mode completed.")).show():$compilationResutlts.html(__("Cannot successfully build the optimized table indexes")).show()
},onCompleteDecompile:function(){$compilationResutlts.html(__("Switch to Design Mode completed")).show(),$compileButton.show(),$decompileButton.show()}},mySwitcher=new Switcher("compilation-grid",options);mySwitcher.init(),$compileButton.click(function(){confirm(__("All classes in Design Mode will switch to Production Mode. Please confirm."))&&mySwitcher.startCompilation()}),$decompileButton.click(function(){confirm(__("All classes in Production Mode will switch to Design Mode. Please confirm."))&&(mySwitcher.startDecompilation(),$compilationResutlts.hide())})}}});
//# sourceMappingURL=routes.js
//# sourceMappingURL=routes.js.map